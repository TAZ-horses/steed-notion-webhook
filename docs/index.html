<script>
  const width = window.innerWidth;
  const height = window.innerHeight;
  const radius = width / 3;

  const svg = d3.select("#mindmap")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", `translate(${width / 2}, ${height / 2})`);

  const tooltip = d3.select("#tooltip");

  // âœ… FIXED: Relative path so it works on Render
  fetch("mindmap_data.json")
    .then(res => res.json())
    .then(data => {
      const root = {
        name: "Steed Media",
        children: Object.entries(data).map(([category, services]) => ({
          name: category,
          icon: services[0]?.icon || "ðŸ§©",
          children: services.map(s => ({
            name: s.service,
            username: s.username,
            description: s.description,
            password: s.password,
            notes: s.notes
          }))
        }))
      };

      const rootNode = d3.hierarchy(root);
      const treeLayout = d3.tree().size([2 * Math.PI, radius]);
      treeLayout(rootNode);

      const link = svg.selectAll(".link")
        .data(rootNode.links())
        .join("path")
        .attr("class", "link")
        .attr("d", d3.linkRadial()
          .angle(d => d.x)
          .radius(d => d.y)
        );

      const node = svg.selectAll(".node")
        .data(rootNode.descendants())
        .join("g")
        .attr("class", "node")
        .attr("transform", d => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`);

      node.append("circle")
        .attr("r", 5)
        .on("mouseover", (e, d) => {
          if (d.data.username || d.data.password || d.data.notes) {
            tooltip.style("display", "block")
              .html(`<strong>${d.data.name}</strong><br>
                     <b>User:</b> ${d.data.username || '-'}<br>
                     <b>Pass:</b> ${d.data.password || '-'}<br>
                     <b>Notes:</b> ${d.data.notes || '-'}`)
              .style("left", (e.pageX + 10) + "px")
              .style("top", (e.pageY - 28) + "px");
          }
        })
        .on("mouseout", () => tooltip.style("display", "none"));

      node.append("text")
        .attr("dy", "0.31em")
        .attr("x", d => d.x < Math.PI === !d.children ? 8 : -8)
        .attr("text-anchor", d => d.x < Math.PI === !d.children ? "start" : "end")
        .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
        .text(d => d.data.icon ? `${d.data.icon} ${d.data.name}` : d.data.name);
    });
</script>
