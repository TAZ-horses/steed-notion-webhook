<script>
  // Color and icon mappings
  const colorMap = {
    "business tools": "#2a423f",
    "Hosting": "#ee0505",
    "development": "#007bff",
    "social media": "#f39c12"
  };

  const iconMap = {
    "business tools": "ðŸ’¼",
    "Hosting": "ðŸŒ",
    "development": "ðŸ’»",
    "social media": "ðŸ“±"
  };

  // Visualization setup
  const width = window.innerWidth;
  const height = window.innerHeight;
  const radius = Math.min(width, height) / 2.2;

  const container = d3.select("#mindmap")
    .attr("width", width)
    .attr("height", height);

  const svg = container.append("g")
    .attr("transform", `translate(${width / 2}, ${height / 2})`);

  container.call(d3.zoom().scaleExtent([0.5, 4]).on("zoom", (e) => {
    svg.attr("transform", e.transform);
  }));

  const tooltip = d3.select("#tooltip");
  let allPasswordsVisible = false;

  // Password toggle function
  function toggleAllPasswords() {
    allPasswordsVisible = !allPasswordsVisible;
    document.querySelectorAll(".password-field").forEach(span => {
      span.textContent = allPasswordsVisible ? span.dataset.pass : "â€¢â€¢â€¢â€¢â€¢â€¢";
    });
    const toggleBtn = document.querySelector("#toolbar button:first-child");
    toggleBtn.textContent = allPasswordsVisible ? "ðŸ”’ Hide Passwords" : "ðŸ”“ Show Passwords";
  }

  // Export as PNG
  function exportAsPNG() {
    const svgEl = document.getElementById("mindmap");
    const svgData = new XMLSerializer().serializeToString(svgEl);
    const canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    const img = new Image();
    img.onload = function() {
      ctx.drawImage(img, 0, 0);
      const png = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      link.download = "steed_mindmap.png";
      link.href = png;
      link.click();
    };
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData)));
  }

  // Main rendering function
  function renderMindmap(data) {
    const root = {
      name: "Steed Media",
      children: Object.entries(data).map(([category, services]) => ({
        name: category,
        color: colorMap[category] || "#888",
        icon: iconMap[category] || "ðŸ“",
        children: services.map(s => ({
          name: s.service,
          description: s.description,
          username: s.username,
          password: s.password,
          notes: s.notes
        }))
      }))
    };

    const rootNode = d3.hierarchy(root);
    const tree = d3.tree().size([2 * Math.PI, radius]);
    tree(rootNode);

    // Draw links
    svg.selectAll(".link")
      .data(rootNode.links())
      .join("path")
      .attr("class", "link")
      .attr("d", d3.linkRadial()
        .angle(d => d.x)
        .radius(d => d.y)
      );

    // Create nodes
    const node = svg.selectAll(".node")
      .data(rootNode.descendants())
      .join("g")
      .attr("class", "node")
      .attr("transform", d => `rotate(${(d.x * 180 / Math.PI - 90)}) translate(${d.y},0)`);

    // Add circles to nodes
    node.append("circle")
      .attr("r", 5)
      .attr("fill", d => d.data.color || "#2a423f");

    // Add text to nodes
    node.append("text")
      .attr("dy", "0.31em")
      .attr("x", d => d.x < Math.PI === !d.children ? 10 : -10)
      .attr("text-anchor", d => d.x < Math.PI === !d.children ? "start" : "end")
      .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
      .text(d => `${d.data.icon || ""} ${d.data.name}`)
      .append("title")
      .text(d => d.data.name);

    // Node click handler
    node.on("click", (event, d) => {
      if (d.data.username || d.data.password || d.data.notes || d.data.description) {
        const passwordContent = d.data.password 
          ? `<b>Pass:</b> <span class="password-field" data-pass="${d.data.password}">
              ${allPasswordsVisible ? d.data.password : "â€¢â€¢â€¢â€¢â€¢â€¢"}
             </span>
             <button class="copy-btn">ðŸ“‹</button><br>`
          : "";

        tooltip.style("display", "block")
          .html(`
            <strong>${d.data.name}</strong><br>
            ${d.data.description ? `<em>${d.data.description}</em><br>` : ""}
            ${d.data.username ? `<b>User:</b> ${d.data.username}<br>` : ""}
            ${passwordContent}
            ${d.data.notes ? `<b>Notes:</b> ${d.data.notes}` : ""}
          `)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 20) + "px");

        // Add click handler for copy button
        if (d.data.password) {
          tooltip.select(".copy-btn").on("click", function() {
            navigator.clipboard.writeText(d.data.password)
              .then(() => {
                this.textContent = "âœ“";
                setTimeout(() => this.textContent = "ðŸ“‹", 1000);
              });
          });
        }
      }
    });

    // Hide tooltip when clicking elsewhere
    svg.on("click", () => tooltip.style("display", "none"));
  }

  // Load data and render mindmap
  fetch("docs/mindmap_data.json?t=" + Date.now())
    .then(res => res.json())
    .then(renderMindmap)
    .catch(err => {
      console.error("Mindmap fetch failed:", err);
      d3.select("body").append("div")
        .style("color", "red")
        .style("padding", "20px")
        .html("<h2>Error loading mindmap data.</h2>");
    });
</script>
